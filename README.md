# B 站音乐收藏助手

## 项目简介

本项目是一个 Python 脚本，旨在帮助用户将 QQ 音乐歌单中的歌曲，自动匹配并收藏到 B 站的收藏夹中。它通过以下步骤实现：

1. **解析 QQ 音乐歌单**: 根据用户提供的 QQ 音乐歌单链接，解析出歌单中的所有歌曲信息（歌名、歌手）。
2. **B 站搜索**: 利用 B 站的搜索 API，根据每首歌的歌名和歌手信息，搜索出相关的视频列表。
3. **智能筛选**: 调用大型语言模型（LLM），根据视频标题、点赞数、播放数、收藏数等信息，从搜索结果中智能筛选出音质、画质最佳，且与歌曲最匹配的视频。
4. **自动收藏**: 将筛选出的 B 站视频自动添加到用户指定的收藏夹中。

## 项目动机

我平时喜欢在 B 站上听歌，但 B 站的音乐资源较为分散，没有像 QQ 音乐那样方便的歌单功能。因此，我开发了这个工具，希望能够将我在 QQ 音乐上创建的歌单，自动同步到 B 站收藏夹中，方便我在 B 站上欣赏音乐。

## 环境配置

1. **Python 版本**: 本项目使用 Python 3 开发，建议使用 Python 3.8 或更高版本。
2. **依赖库**: 需要安装以下 Python 库：

   * `requests`: 用于发送 HTTP 请求。
   * `openai`: 用于调用 OpenAI 的 API。
   * `json`: 用于处理 JSON 数据。
   * `time`: 用于控制程序运行速度。
   * `re`: 用于正则表达式匹配。

   可以使用以下命令安装这些依赖库：

   ```bash
   pip install requests openai
   ```

## 使用说明

### 输入信息

运行脚本前，你需要准备以下信息：

1. **B 站 Cookie 信息**:

   * `SESSDATA`: 用于保持登录状态。
   * `bili_jct`: 用于验证请求。
   * `DedeUserID`: 你的 B 站用户 ID。

   获取方式：登录 B 站网页版后，打开浏览器的开发者工具（通常按 F12 键），在“网络”(Network) 标签页中，找到任意一个 B 站的请求，在请求头 (Request Headers) 中可以找到这些 Cookie 信息。
2. **B 站收藏夹 ID**: 你想要将视频添加到哪个收藏夹？在 B 站收藏夹页面的 URL 中可以找到收藏夹 ID，例如 `https://space.bilibili.com/xxx/favlist?fid=3356761953` 中的 `3356761953` 就是收藏夹 ID。
3. **LLM API Key**: 用于调用LLM 的 API。现在有很多白嫖的方案，比如[Free ChatGPT API Key](https://github.com/chatanywhere/GPT_API_free)，可以自行选择。本插件交互量较大，没必要用自己购买的key完成。
4. **QQ 音乐歌单 URL**: 你想要同步的 QQ 音乐歌单链接，例如 `https://y.qq.com/n/ryqq/playlist/8764695552`。

### 运行步骤

1. **输入 Cookie 和 Token 信息**：

   * 运行脚本后，首先会提示你输入 B 站的 `SESSDATA`、`bili_jct` 和 `DedeUserID`。
   * 然后会提示你输入 LLM 的 API Key。
2. **输入 QQ 音乐歌单 URL**：

   * 程序会提示你输入 QQ 音乐歌单页面的 URL。
3. **输入自定义 base_url（可选）**：

   * 如果你需要使用自定义的 API base_url，可以在这里输入。否则，直接回车使用默认值 `https://openai.com/v1`。这个不懂的可以自行参考各LLM代理商，都懂。
4. **输入自定义 system_prompt（可选）**：

   * 如果你需要自定义 LLM 的 system_prompt，可以在这里输入。否则，直接回车使用默认值。默认的 system_prompt 已经针对音乐视频选择进行了优化，通常不需要修改。
5. **输入每批处理的歌曲数量**：

   * 为了避免请求过于频繁，程序会将歌曲分批处理。你可以输入每批处理的歌曲数量，建议值为 20，不要超过 30，否则可能会因为 LLM 的输入长度限制而报错。
6. **自动运行**：

   * 输入完以上信息后，程序会自动运行，依次处理每批歌曲。
   * 对于每首歌，程序会先在 B 站搜索相关视频，然后调用 LLM 筛选出最佳视频，最后将视频添加到收藏夹。
   * 程序会输出每个步骤的处理结果，方便你了解运行状态。

### 运行结果

程序运行过程中，会输出以下信息：

* 获取到的 QQ 音乐歌单中的歌曲数量。
* 每批处理的歌曲范围。
* 每首歌的搜索结果数量。
* LLM 的完整输入和响应（方便调试）。
* LLM 选择的最佳视频结果。
* 每首歌对应的视频是否成功添加到收藏夹。
* 最终处理结束的提示。

### 参数调整

* **`batch_size`**: 可以通过调整每批处理的歌曲数量 (`batch_size`) 来控制程序的运行速度和请求频率。如果你的网络环境较好，可以适当增大 `batch_size`。如果网络环境较差，或者遇到 B 站的风控提示，可以适当减小 `batch_size`。
* **`system_prompt`**:  如果你对 LLM 的选择结果不满意，可以尝试修改 `system_prompt`，调整 LLM 的选择策略。例如，你可以修改 `system_prompt` 中的排序重要性，或者添加其他筛选条件。我另外附了一份prompt，歌的准确率更高，但是一般

### 异常处理

* **Cookie 失效**: 如果程序在运行过程中出现多次搜索失败的情况，可能是 B 站的 Cookie 失效了。程序会提示你重新输入 `SESSDATA`、`bili_jct` 和 `DedeUserID`。这个有个很神奇的方案是等个几秒原封不动输入也可以。如果出现仍然不行，就需要删除浏览器cookie了
* **网络问题**: 如果程序无法访问 B 站或 OpenAI 的 API，可能是网络问题。请检查你的网络连接，或者稍后再试。
* **LLM 返回格式错误**: 如果 LLM 返回的结果无法解析成 JSON 格式，程序会输出错误信息，并跳过当前批次的歌曲。你可以根据错误信息，尝试修改 `system_prompt` 或者联系开发者寻求帮助。
* **收藏夹已满**: 如果你的收藏夹已满，程序会提示添加视频到收藏夹失败。你需要先清理收藏夹，或者更换其他收藏夹。

## 注意事项

* 请勿频繁使用本工具，以免触发 B 站的风控机制。
* 本工具仅供学习交流使用，请勿用于商业用途。
* 使用本工具产生的任何风险由用户自行承担。

## 免责声明

本工具是一个开源项目，开发者不对其产生的任何后果负责。用户在使用本工具时，应遵守相关法律法规和网站的使用协议。
